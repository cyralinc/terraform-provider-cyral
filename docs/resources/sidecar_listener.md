# cyral_sidecar_listener (Resource)

Manages [sidecar listeners](https://cyral.com/docs/sidecars/sidecar-listeners).
~> **Warning** Multiple listeners can be associated to a single sidecar as long as `host` and `port` are unique. If `host` is omitted, then `port` must be unique.

-> Import ID syntax is `{sidecar_id}/{listener_id}`.

## Example Usage

```terraform
resource "cyral_sidecar" "sidecar" {
  name              = "sidecar"
  deployment_method = "docker"
}

// Plain listener
resource "cyral_sidecar_listener" "listener" {
  sidecar_id = cyral_sidecar.sidecar.id
  repo_types = ["mongodb"]
  network_address {
    port = 27017
  }
}

// Listener with MySQL Settings
resource "cyral_sidecar_listener" "listener_mysql" {
  sidecar_id = cyral_sidecar.sidecar.id
  repo_types = ["mysql"]
  network_address {
    port = 3306
  }

  mysql_settings {
    db_version    = "8.0.4"
    character_set = "utf8mb4_0900_ai_ci"
  }
}

# Listener for S3 CLI and AWS SDK
resource "cyral_sidecar_listener" "listener_s3_cli" {
  sidecar_id = cyral_sidecar.sidecar.id
  repo_types = ["s3"]
  network_address {
    port = 443
  }
  s3_settings {
    proxy_mode = true
  }
}

# Listener for S3 browser (using port 444 assuming port
# 443 is used for CLI)
resource "cyral_sidecar_listener" "listener_s3_cli" {
  sidecar_id = cyral_sidecar.sidecar.id
  repo_types = ["s3"]
  network_address {
    port = 444
  }
  s3_settings {
    // may be omitted for s3 browser as it defaults to `false`
    proxy_mode = false
  }
}


# Listener with DynamoDB Settings
resource "cyral_sidecar_listener" "listener_dynamodb" {
  sidecar_id = cyral_sidecar.sidecar.id
  repo_types = ["dynamodb"]
  network_address {
    port = 8000
  }
  dynamodb_settings {
    // must be true if repo_type is either `dynamodb` or `dynamodbstreams`
    proxy_mode = true
  }
}
```

<!-- schema generated by tfplugindocs -->

## Schema

### Required

- `network_address` (Block Set, Min: 1, Max: 1) The network address that the sidecar listens on. (see [below for nested schema](#nestedblock--network_address))
- `repo_types` (List of String) List of repository types that the listener supports. Currently limited to one repo type from supported repo types:
  - `denodo`
  - `dremio`
  - `dynamodb`
  - `dynamodbstreams`
  - `galera`
  - `mariadb`
  - `mongodb`
  - `mysql`
  - `oracle`
  - `postgresql`
  - `redshift`
  - `s3`
  - `snowflake`
  - `sqlserver`
- `sidecar_id` (String) ID of the sidecar that the listener will be bound to.

### Optional

- `dynamodb_settings` (Block Set, Max: 1) DynamoDB settings. (see [below for nested schema](#nestedblock--dynamodb_settings))
- `mysql_settings` (Block Set, Max: 1) MySQL settings represents the listener settings for a [`mysql`, `galera`, `mariadb`] data repository. (see [below for nested schema](#nestedblock--mysql_settings))
- `override_repo_client_tls_settings` (Boolean) Override TLS settings defined in the repo. Default value generated by API if not provided.
- `s3_settings` (Block Set, Max: 1) S3 settings. (see [below for nested schema](#nestedblock--s3_settings))
- `tls_mode` (String) TLS mode. Default value generated by API if not provided. Note! This field is in effect only if OverrideRepoClientTlsSettings is set to true or the listener is a SMART port (enabled in more than one binding). Allowed values:
  - `allow`
  - `require`
  - `disable`.

### Read-Only

- `id` (String) The ID of this resource.
- `listener_id` (String) ID of the listener that will be bound to the sidecar.

<a id="nestedblock--network_address"></a>

### Nested Schema for `network_address`

Required:

- `port` (Number) Port where the sidecar will listen for the given repository.

Optional:

- `host` (String) Host where the sidecar will listen for the given repository, in the case where the sidecar is deployed on a host with multiple network interfaces. If omitted, the sidecar will assume the default "0.0.0.0" and listen on all network interfaces.

<a id="nestedblock--dynamodb_settings"></a>

### Nested Schema for `dynamodb_settings`

Optional:

- `proxy_mode` (Boolean) DynamoDB proxy mode. Only relevant for listeners of type `dynamodb` or `dynamodbstreams` and must always be set to `true` for these listener types. Defaults to false. When `true`, instructs the sidecar to operate as an HTTP Proxy server. Client applications need to be explicitly configured to send the traffic through an HTTP proxy server, represented by the Cyral sidecar endpoint + the DynamoDB listening port. It is indicated when connecting from CLI applications, such as `aws cli`, or through the AWS SDK.Setting this value to `false` for the `dynamodb` and `dynamodbstreams` listeners types is currently not allowed and is reserved for future use.

<a id="nestedblock--mysql_settings"></a>

### Nested Schema for `mysql_settings`

Optional:

- `character_set` (String) MySQL character set. Optional (and only relevant) for listeners of types `mysql` and `mariadb`. The sidecar automatically derives this value out of the server version specified in the dbVersion field. This field should only be populated if the database was configured, at deployment time, to use a global character set different from the database default. The char set is extracted from the collation informed. The list of possible collations can be extracted from the column `collation` by running the command `SHOW COLLATION` in the target database.
- `db_version` (String) MySQL advertised DB version. Required (and only relevant) for listeners of types `mysql` and `mariadb`. This value represents the MySQL/MariaDB server version that the Cyral sidecar will use to present itself to client applications. Different applications, especially JDBC-based ones, may behave differently according to the version of the database they are connecting to. It is crucial that version value specified in this field to be either the same value as the underlying database version, or to be a compatible one. For a compatibility reference, please access: https://cyral.com/docs/v4.2/sidecars/sidecar-bind-repo#mysql-smart-port-configuration. Example values: `"5.7.3"`, `"8.0.4"` or `"10.2.1"`.

<a id="nestedblock--s3_settings"></a>

### Nested Schema for `s3_settings`

Optional:

- `proxy_mode` (Boolean) S3 proxy mode. Only relevant for S3 listeners. Allowed values: [true, false]. Defaults to `false`. When `true`, instructs the sidecar to operate as an HTTP Proxy server. Client applications need to be explicitly configured to send the traffic through an HTTP proxy server, represented by the Cyral sidecar endpoint + the S3 listening port. It is indicated when connecting from CLI applications, such as `aws cli`, or through the AWS SDK. This listener mode is functional for client applications using either AWS native credentials, e.g. Access Key ID/Secret Access Key, or Cyral-Provided access tokens (Single Sign-On connections). When `false`, instructs the sidecar to mimic the actual behavior of AWS S3, meaning client applications will not be aware of a middleware HTTP proxy in the path to S3. This listener mode is only compatible with applications using Cyral-Provided access tokens and is must used when configuring the Cyral S3 Browser. This mode is currently not recommended for any other use besides the Cyral S3 Browser.
